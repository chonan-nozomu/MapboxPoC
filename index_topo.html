<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Show and hide layers</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.3.1/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  <link href="./css/index.css" rel="stylesheet" />
</head>

<body>
  <div id="map"></div>
  <div id="menu1">
    <input id="gsi-vector" type="radio" name="rtoggle" value="vector" checked="checked" />
    <label for="gsi-vector">ベクタ(地理院標準)</label>
    <input id="gsi-raster" type="radio" name="rtoggle" value="raster" />
    <label for="gsi-raster">ラスタ(地理院淡色)</label>
  </div>
  <div id="menu2">
    <a href="#" id="canvas1" class="active" onclick="downloadCanvas();">canvas出力(96dpi)</a>
    <a href="#" id="api" class="active" onclick="downloadStaticImage();">Static Image API</a>
  </div>
  <canvas id="canvas"></canvas>
  <a id="hiddenLink" style="display:none;">link</a>
  <!-- directions -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css" />
  <!-- geocoder (search)
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css" type="text/css"/>
-->
  <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
-->
  <!-- jsPDF
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.2.0/jspdf.umd.min.js"></script>
 -->
  <!-- html2canvas 
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.5/dist/html2canvas.min.js"></script>
-->
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2hvbmFuLW5vem9tdSIsImEiOiJja2k1bHJjbDg0ZXZ2MnFrem81NWlmaG90In0.v__tuK8SHq9Q2IGKM9ZFwQ';
    var map = new mapboxgl.Map({
      container: "map",
      hash: true,
      style: "./style/gsi-vector.json",
      zoom: 14,
      center: [139.618030, 35.734292]
    });
    map.addControl(new mapboxgl.ScaleControl(), "bottom-left");
    //  map.addControl(new MapboxGeocoder({accessToken: mapboxgl.accessToken,language: 'ja-JP',mapboxgl: mapboxgl}));
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
//    map.addControl(new MapboxDirections({accessToken: mapboxgl.accessToken}), 'top-left');

    // ポリゴン追加（topojson＋d3.js版）
    d3.json("https://chonan-nozomu.github.io/MapboxPoC/topojson/13000.topojson").then(createFeature);
    function createFeature(topo) {
      // TopoJSONをGeoJSONに変換する
      var geojson = topojson.feature(topo, topo.objects['13000']);
      // svg要素をアペンドする
      var container = map.getCanvasContainer();
      var svg = d3.select(container).append("svg");

      // TODO translateとscale
      var mapboxProjection = d3.geoTransform({point: function(lng, lat) {
        var point = map.project(new mapboxgl.LngLat(lng, lat));
		    this.stream.point(point.x, point.y);
      }});
      var path = d3.geoPath().projection(mapboxProjection);
      var center = map.getCenter();
      var zoom = map.getZoom();
      // 512 is hardcoded tile size, might need to be 256 or changed to suit your map config
      var scale = (512) * 0.5 / Math.PI * Math.pow(2, zoom);
      var projection = d3
        .geoMercator() //投影法の指定
        .scale(scale)	//スケール（ズーム）の指定
        .center([center.lng, center.lat]); //中心の座標を指定
      // var path = d3.geoPath().projection(projection);
      var featureElement = svg.append("g").selectAll("path")
        .data(geojson.features)
        .enter()
          .append("path")
          .attr("stroke", "#BB641D")
          .attr("stroke-width", "1.5")
          .attr("fill", "none");
      function renderFeature() {
        featureElement.attr("d", path);  //dataに投影法を適応
      }
      map.on("viewreset", renderFeature);
      map.on("movestart", function() {
        svg.style("visibility", "hidden");
      });	
      map.on("rotate", function() {
        svg.style("visibility", "visible");
      });	
      map.on("moveend", function() {
        renderFeature();
        svg.style("visibility", "visible");
      });
      var inputs = document.getElementById('menu1').getElementsByTagName('input');
      function switchLayer(layer) {
        var layerId = layer.target.id;
        map.setStyle("./style/" + layerId + ".json");
        renderFeature();
      }
      for (var i = 0; i < inputs.length; i++) {
        inputs[i].onclick = switchLayer;
      }
      renderFeature();
      /*
      //ズームイベント設定 TODO
      var zoomed = d3.zoom().scaleExtent([1 / 2, 12]).on('zoom', function(event, d){
        featureElement.attr('transform', event.transform);
      });
      svg.call(zoomed);
      //ドラッグイベント設定 TODO
      var dragged = d3.drag().on('drag', function(event, d){
        var tl = projection.translate();
        projection.translate([tl[0] + event.dx, tl[1] + event.dy]);
        featureElement.attr('d', path);
      });
      svg.call(dragged);
      */
    }

    // 画像ダウンロード
    function downloadCanvas() {
      let canvas = document.getElementById("canvas");
      let link = document.getElementById("hiddenLink");
      link.href = map.getCanvas().toDataURL("image/png");
      link.download = "canvas.png"
      link.click();
    }
    // 静的HTMLダウンロード
    function downloadStaticImage() {
      let link = document.getElementById("hiddenLink");
      link.href = "https://api.mapbox.com/styles/v1/chonan-nozomu/ckj0qqpqe0uie1arqbobct40r/static/pin-l-z+0000ff(139.75175,35.68551)/139.75175,35.68551,10,0/500x400@2x?access_token=" + mapboxgl.accessToken;
      link.download = "image.png";
      link.target = "_blank";
      link.click();
      link.target = "";
    }
  </script>
</body>

</html>